
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Stop writing Rails applications - rylwin's blog</title>
  <meta name="author" content="Ryan Winograd">

  
  <meta name="description" content="TL;DR Don&rsquo;t just throw all your code in app/models; don&rsquo;t just build a Rails app.
Have another directory that contains all of your domain &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://rylwin.github.io/blog/2013/09/29/stop-writing-rails-applications">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="rylwin's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-6332560-8']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">rylwin's blog</a></h1>
  
    <h2>coding for results</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:rylwin.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Stop Writing Rails Applications</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-29T16:01:00-05:00" pubdate data-updated="true">Sep 29<span>th</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><h2>TL;DR</h2>

<p>Don&rsquo;t just throw all your code in <code>app/models</code>; don&rsquo;t just build a Rails app.
Have another directory that contains all of your domain-specific logic. Put some
thought into how you organize the files in that directory. And there&rsquo;s a rule to
follow: files in this directory must not invoke any Rails-provided methods.</p>

<h2>Write an application for your domain, not a Rails app</h2>

<p>Don&rsquo;t get me wrong. <strong>Rails is fantastic</strong>&mdash;I love it! But my past Rails
projects all eventually suffer from poor architecture and slow tests. <strong>It&rsquo;s not
Rails&#8217; fault, it&rsquo;s mine. I&rsquo;ve been leaning too heavily on Rails this whole
time.</strong> Now I&rsquo;m finally learning how to build great apps that I enjoy working on
long beyond the prototype stage.</p>

<p>The key to building an application with Rails that stands the test of time is to
not use Rails as the defining feature of the application.  <strong>Rails is just a
delivery mechanism and a persistence layer</strong>.  The domain logic should be
separate from Rails. (Thanks to Bob Martin for
<a href="http://youtu.be/WpkDN78P884">motivating me to confront this this issue</a>.)</p>

<p>At the same time, <strong>Rails provides a lot of default goodness out of the box. I
do not want a lot of extra code that re-invents anything</strong> already provided
by Rails. The goal is to achieve an improved architecture without sacrificing
the ease provided by Rails.</p>

<p>I&rsquo;ve split this post into two parts (ignoring this intro). The first is a
high-level explanation of the architecture that I&rsquo;m proposing.  In the second
section, I&rsquo;ll show some of the code I&rsquo;m using to get this all to work.</p>

<h2>The Architecture (from 20k ft)</h2>

<p>The short version: <code>app/models</code> contains my ActiveRecord models and <code>app/lib</code>
contains application / domain-specific logic.</p>

<h3>app/models</h3>

<p>The <strong>classes in <code>app/models</code> should be ActiveRecord classes or classes that
extensively use the ActiveRecord API</strong> (e.g., query-helper classes).
Additionally, code in <strong><code>app/models</code> should know nothing of our domain logic</strong>.
The classes should be focused only on data retrieval and storage. One way to
think of <code>app/models</code> classes is as <strong>facades to the ActiveRecord API</strong>.</p>

<p>I use ActiveRecord models throughout the application, but <strong>I don&rsquo;t write any
code outside of <code>app/models</code> that directly uses an ActiveRecord method</strong>. This
means that, in code outside of <code>app/models</code>, I only invoke standard field
getters/setters and methods that I&rsquo;ve defined on the models.</p>

<p>This approach is a balancing act. For example, I let scaffolded controllers
invoke ActiveRecord methods&mdash;I&rsquo;m not going to spend time updating the default
controllers.  This goes to the point of not creating extra work / reinventing
the wheel.  After all, one could have PORO classes to represent each
ActiveRecord model to the rest of the application, but achieving this would
require a decent amount of work for what may be an almost entirely academic
benefit.</p>

<h3>app/lib</h3>

<p>The <strong><code>app/lib</code> directory contains the business/domain logic</strong>. The code in
<code>app/lib</code> must have <strong>no knowledge of Rails</strong>&mdash;none at all.  <code>app/lib</code> classes
(all POROs) can still use the model classes, but they are not allowed to use any
ActiveRecord API methods (except the field getters/setters). This means direct
invocation of <code>save</code>, <code>create</code>, <code>update_attributes</code>, all querying, etc. is off
limits.</p>

<p>By separating the application logic into a separate directory, I&rsquo;ve found it
much <strong>easier to make good architectural decisions</strong>. A nice benefit of this
approach is that it makes it very easy to write
<a href="http://arrrrcamp.be/videos/corey-haines/fast-rails-tests">fast_specs</a> since I
know that code in <code>app/lib</code> does not have dependencies on Rails or the database.
All models in <code>app/lib</code> have their specs located in a <code>fast_spec</code> directory.</p>

<p>The classes within <code>app/lib</code> are organized into modules. The modules you define
will vary depending on your domain, but I&rsquo;ll share a few of mine from a project
I&rsquo;m working on:</p>

<h4>Integration &ndash; interaction with remote data sources</h4>

<p>Integration classes are responsible for interacting with remote data sources.
These classes have no dependencies on our other classes. The external sources
may be remote APIs, uploaded data files, etc.</p>

<h4>Render &ndash; renders documents in various formats</h4>

<p>Classes in the render module are responsible for rendering non-HTML/JSON views
(e.g., render a PDF, XLS, etc). It is often useful to be able to generate these
files outside of the standard request/response cycle and it&rsquo;s much easier to
test the result when it&rsquo;s just plain Ruby.</p>

<h4>Service &ndash; encapsulates user story logic</h4>

<p>Service classes encapsulate the logic of our user stories (or parts of stories).
The service classes decrease complexity and coupling in the system by their
organization and by providing interaction between the persistence layer
(<code>app/models</code>) and the domain logic layer (<code>app/lib</code>). Service classes may
invoke other service classes to build more complex behaviors.</p>

<h4>Util &ndash; code not relevant to our domain</h4>

<p>Any code unrelated to our specific domain gets placed here (e.g., I have a class
that converts XLSB files to XLS and another that compares hashes). Anything you
throw in here might be a good candidate for a gem!</p>

<h2>This sounds awesome. How can I do it? (i.e., the code)</h2>

<h3>Setting up <code>app/lib</code></h3>

<p>Add the following to config/application.rb:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">autoload_paths</span> <span class="o">+=</span> <span class="sx">%W(</span><span class="si">#{</span><span class="n">config</span><span class="o">.</span><span class="n">root</span><span class="si">}</span><span class="sx">/app/lib)</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&rsquo;s all you need to do in order to begin adding code into <code>app/lib</code>! Here&rsquo;s
what my <code>app/lib</code> looks like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>integration/    render/     service/    util/
</span><span class='line'>integration.rb  render.rb   service.rb  util.rb
</span></code></pre></td></tr></table></div></figure>


<p>Each folder (module) has a simple file with the same name that creates the
module. E.g.,:</p>

<figure class='code'><figcaption><span>service.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Service</span><span class="p">;</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Setting up <code>fast_spec</code></h3>

<p>For the corresponding fast_specs, add a <code>fast_spec</code> directory at the top level
of your project. Then add a file <code>fast_spec/spec_fast_helper.rb</code>:</p>

<figure class='code'><figcaption><span>fast_spec/spec_fast_helper.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler&#39;</span>
</span><span class='line'><span class="c1"># require &#39;other gems from your bundle&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">root</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set up any configuration here...</span>
</span><span class='line'><span class="c1"># I18n.load_path = [File.join(root, &#39;config&#39;, &#39;locales&#39;, &#39;en.yml&#39;)]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Require your app/lib folder. You may need to require some classes first</span>
</span><span class='line'><span class="c1"># depending on how you&#39;ve set up your class hierarchy.</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;lib&#39;</span><span class="p">,</span> <span class="s1">&#39;**&#39;</span><span class="p">,</span> <span class="s1">&#39;*.rb&#39;</span><span class="p">)</span><span class="o">].</span><span class="n">sort</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">lib</span><span class="o">|</span>
</span><span class='line'>  <span class="nb">require</span> <span class="n">lib</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also added a rake task so that I can <code>rake fast</code>:</p>

<figure class='code'><figcaption><span>lib/tasks/000_fast.rake</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rspec&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s2">&quot;Run fast specs&quot;</span>
</span><span class='line'><span class="ss">RSpec</span><span class="p">:</span><span class="ss">:Core</span><span class="o">::</span><span class="no">RakeTask</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:fast</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>
</span><span class='line'>  <span class="n">task</span><span class="o">.</span><span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;fast_spec/**/*_spec.rb&#39;</span>
</span><span class='line'>  <span class="n">task</span><span class="o">.</span><span class="n">rspec_opts</span> <span class="o">=</span> <span class="s1">&#39;-Ifast_spec&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="ss">:fast</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now in each fast_spec file just <code>require 'spec_fast_helper'</code>. If you like guard,
check out <a href="https://github.com/shutl/guard-fast_spec">guard-fast_spec</a>. And if
you haven&rsquo;t been using guard because your tests have been too slow, try it
again.  When your tests are this fast you&rsquo;ll love it.</p>

<p>When I need to include ActiveRecord models in the tests, I just use stubs. The
danger here is that your specs become out of sync with your models, but a decent
integration test suite should catch these issues.</p>

<p>Since all the complicated logic is contained in <code>fast_spec</code>, the specs in <code>spec</code>
are all simple. Really simple. Which means that those specs run decently fast:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time </span>rake spec
</span><span class='line'><span class="c"># output truncated</span>
</span><span class='line'>...............................................................................
</span><span class='line'>...............................................................................
</span><span class='line'>...............................................................................
</span><span class='line'>...............................................................................
</span><span class='line'>..................................
</span><span class='line'>
</span><span class='line'>Finished in 6.82 seconds
</span><span class='line'>350 examples, 0 failures
</span><span class='line'>
</span><span class='line'>rake spec  19.44s user 1.62s system 93% cpu 22.624 total
</span></code></pre></td></tr></table></div></figure>


<p>And the <code>fast_specs</code>?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">time </span>rake fast
</span><span class='line'><span class="c"># output truncated</span>
</span><span class='line'>...............................................................................
</span><span class='line'>...............................................................................
</span><span class='line'>........
</span><span class='line'>
</span><span class='line'>Finished in 1.09 seconds
</span><span class='line'>166 examples, 0 failures
</span><span class='line'>
</span><span class='line'>rake fast  7.91s user 0.77s system 98% cpu 8.798 total
</span></code></pre></td></tr></table></div></figure>


<p>It&rsquo;s still a young app so there aren&rsquo;t a ton of specs, but I think you get the
idea.</p>

<h2>Minimal changes, big results</h2>

<p>This simple organizational change (along with the associated rules) makes it
easier for me to employ good OOP design principles in my projects that use
Rails, yet I&rsquo;m still able to reap the benefit of Rails (which is plenty!).</p>

<p>Let me know if you like this idea. If there&rsquo;s interest, I&rsquo;ll write some
follow-up posts with code samples that demonstrate how I&rsquo;m using this <code>app/lib</code>
organization to write cleaner, more modular code.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Ryan Winograd</span></span>

      








  


<time datetime="2013-09-29T16:01:00-05:00" pubdate data-updated="true">Sep 29<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://rylwin.github.io/blog/2013/09/29/stop-writing-rails-applications/" data-via="" data-counturl="http://rylwin.github.io/blog/2013/09/29/stop-writing-rails-applications/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/07/29/stop-writing-js-for-nested-attributes/" title="Previous Post: Stop writing JS for nested attributes">&laquo; Stop writing JS for nested attributes</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/09/29/stop-writing-rails-applications/">Stop writing Rails applications</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/07/29/stop-writing-js-for-nested-attributes/">Stop writing JS for nested attributes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/06/25/perfect-remote-pair-environment/">The Perfect Remote Pair Environment</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/04/19/sending-emails-via-gmail-as-another-person/">Sending emails via Gmail as "another person"</a>
      </li>
    
      <li class="post">
        <a href="/blog/2012/02/04/skip-reloading-fixtures-each-time-you-run-your-rails-tests/">Skip reloading fixtures each time you run your Rails tests</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Ryan Winograd -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'rylwinsblog';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://rylwin.github.io/blog/2013/09/29/stop-writing-rails-applications/';
        var disqus_url = 'http://rylwin.github.io/blog/2013/09/29/stop-writing-rails-applications/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
